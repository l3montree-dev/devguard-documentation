import { useState } from 'react'
import { ChevronDown } from 'lucide-react'
import { Vuln, AffectedComponent } from './types'

interface VulnerabilityListProps {
    vulns: Vuln[]
    affectedComponents: AffectedComponent[]
}

function getSeverityColor(cvss: number) {
    if (cvss >= 9) return 'text-red-600'
    if (cvss >= 7) return 'text-orange-500'
    if (cvss >= 4) return 'text-yellow-500'
    return 'text-green-400'
}

function getSeverityLabel(cvss: number) {
    if (cvss >= 9) return 'Critical'
    if (cvss >= 7) return 'High'
    if (cvss >= 4) return 'Medium'
    return 'Low'
}

export default function VulnerabilityList({
    vulns,
    affectedComponents,
}: VulnerabilityListProps) {
    const [expanded, setExpanded] = useState(false)

    const cveMap = new Map<
        string,
        { cvss: number; datePublished: string; description: string }
    >()
    for (const ac of affectedComponents) {
        for (const cve of ac.cves) {
            if (!cveMap.has(cve.cve)) {
                cveMap.set(cve.cve, {
                    cvss: cve.cvss,
                    datePublished: cve.datePublished,
                    description: cve.description,
                })
            }
        }
    }

    const visible = expanded ? vulns : vulns.slice(0, 7)
    const hasMore = vulns.length > 7

    return (
        <div>
            <h2 className="mb-4 text-xl font-semibold text-white">
                Vulnerabilities fixed in later releases
            </h2>
            {vulns.length === 0 ? (
                <p className="rounded-md border border-gray-700 bg-gray-800 px-4 py-3 text-sm text-gray-400">
                    None found
                </p>
            ) : (
                <div className="space-y-3">
                    {visible.map((vuln) => {
                        const details = cveMap.get(vuln.cveId)
                        return (
                            <div
                                key={vuln.cveId}
                                className="rounded-md border border-gray-700 bg-gray-800 p-3"
                            >
                                <div className="flex items-center justify-between">
                                    <span className="text-sm font-semibold text-white">
                                        {vuln.cveId}
                                    </span>
                                    {details && (
                                        <span
                                            className={`${getSeverityColor(details.cvss)} text-sm font-medium`}
                                        >
                                            {getSeverityLabel(details.cvss)}{' '}
                                            {details.cvss}
                                        </span>
                                    )}
                                </div>
                                <div className="mt-1 flex items-center gap-3 text-xs text-gray-400">
                                    <span>Fixed in: v{vuln.fixedVersion}</span>
                                    {details && (
                                        <span>
                                            {'Published: '}
                                            {new Date(
                                                details.datePublished,
                                            ).toLocaleDateString('en-US', {
                                                year: 'numeric',
                                                month: 'short',
                                                day: 'numeric',
                                            })}
                                        </span>
                                    )}
                                </div>
                            </div>
                        )
                    })}
                </div>
            )}
            {hasMore && !expanded && (
                <button
                    onClick={() => setExpanded(true)}
                    className="mt-3 flex w-full items-center justify-center gap-1 rounded-md border border-gray-700 py-1.5 text-sm text-gray-400 hover:bg-gray-800"
                >
                    <ChevronDown className="h-4 w-4" />
                    {vulns.length - 7} more
                </button>
            )}
        </div>
    )
}
