'use client'

import { ColumnDef } from '@tanstack/react-table'
import { ArrowUpDown } from 'lucide-react'
import { Button } from '@/components/ui/button'
import Link from 'next/link'

export type Vulnerability = {
    cve: string
    cvss: number
    datePublished: Date
    risk?: number
    description: string
}

export const columns: ColumnDef<Vulnerability>[] = [
    {
        accessorKey: 'cve',
        header: 'ID',
        size: 150,
        cell: ({ row }) => (
            <Link href={`/vulnerability-database/${row.getValue('cve')}`}>
                <div className="w-32">{row.getValue('cve')}</div>
            </Link>
        ),
    },
    {
        accessorKey: 'description',
        header: 'Description',
        size: 600,
        cell: ({ row }) => {
            const description = row.getValue('description') as string
            const truncated =
                description?.length > 100
                    ? description.substring(0, 100) + '...'
                    : description
            return <div className="w-108">{truncated}</div>
        },
    },
    {
        accessorKey: 'cvss',
        size: 100,
        header: ({ column }) => {
            return (
                <div
                    className="flex cursor-pointer items-center hover:text-accent-foreground"
                    onClick={() =>
                        column.toggleSorting(column.getIsSorted() === 'asc')
                    }
                >
                    CVSS
                    <ArrowUpDown className="ml-2 h-4 w-4" />
                </div>
            )
        },
        cell: ({ row }) => <div className="w-20">{row.getValue('cvss')}</div>,
    },
    {
        accessorKey: 'datePublished',
        size: 150,
        header: ({ column }) => {
            return (
                <div
                    className="flex cursor-pointer items-center hover:text-accent-foreground"
                    onClick={() =>
                        column.toggleSorting(column.getIsSorted() === 'asc')
                    }
                >
                    Published
                    <ArrowUpDown className="ml-2 h-4 w-4" />
                </div>
            )
        },
        cell: ({ row }) => {
            const dateStr = row.getValue('datePublished') as string
            const date = new Date(dateStr)
            const now = new Date()
            const diffMs = now.getTime() - date.getTime()
            const diffMins = Math.floor(diffMs / (1000 * 60))
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60))
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))

            let formatted
            if (diffMins < 60) {
                formatted = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`
            } else if (diffHours < 24) {
                formatted = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`
            } else {
                const day = date.getDate()
                const month = date.toLocaleDateString('en-US', {
                    month: 'short',
                })
                const year = date.getFullYear().toString().slice(-2)
                formatted = `${day}. ${month} ${year}`
            }

            return <div className="w-32">{formatted}</div>
        },
    },
]
